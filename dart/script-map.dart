import "dart:html" as j;import "dart:js" as k;import "dart:math" as s;import "dart:convert" as NB;import "dart:async" as nB;class dB{static const String eB="Chrome";static const String fB="Firefox";static const String gB="Internet Explorer";static const String hB="Safari";final String SB;final String minimumVersion;const dB(this.SB,[this.minimumVersion]);}class iB{const iB();}class jB{final String name;const jB(this.name);}class kB{const kB();}class lB{const lB();}class OB{void EB(){oB();pB();qB();rB();sB();tB();uB();vB();}void oB(){j.Element e=j.querySelector('.close-jumbotron-button');j.Element f=j.querySelector('.open-jumbotron-button');if(e==null||f==null){return;}j.Element b=j.querySelector('.jumbotron');j.Element c=j.querySelector('.jumbotron-folded');e.onClick.listen((d){b.style.display='none';c.style.display='block';IB('closeJumbotron','1',expires:180);d.stopPropagation();});f.onClick.listen((d){b.style.display='block';c.style.display='none';IB('closeJumbotron','0',expires:180);d.stopPropagation();});if(RB('closeJumbotron')=='1'){b.style.display='none';c.style.display='block';}}void pB(){j.Element d=j.querySelector('.navbar-toggle-button');j.Element b=j.querySelector('.navbar-collapsible-block');bool c=false;var e=(wB){if(c){b.classes..add('in')..remove('collapse')..remove('collapsing');}else{b.classes..add('collapse')..remove('collapsing')..remove('in');b.style.height='0';}};b.onTransitionEnd.listen(e);d.onClick.listen((g){c=!c;b.classes..add('collapsing')..remove('collapse')..remove('in');if(c){int f=b.scrollHeight+1;b.style.height="${f}px";}else{b.style.height="0";}});}void qB(){List<j.Node> f=j.document.getElementsByTagName('span');DateTime g=new DateTime.now();Duration h=g.timeZoneOffset;List<String> i=const['Понедельник','Вторник','Среда','Четверг','Пятница','Суббота','Воскресенье'];List<String> m=const['января','февраля','марта','апреля','мая','июня','июля','августа','сентября','октября','ноября','декабря'];f.forEach((j.Element c){String d=c.dataset['postDate'];if(d==null){return;}DateTime e=DateTime.parse(d);if(e==null){return;}DateTime b=e.add(h);c.text="${i[b.weekday-1]}, ${b.day} ${m[b.month-1]} ${b.year}" ", ${b.hour<10?'0':''}${b.hour}:${b.minute<10?'0':''}${b.minute}";});}void rB(){j.ElementList c=j.querySelectorAll('span.post-comments');if(c.length==0){return;}new nB.Timer.periodic(new Duration(microseconds:100),(g){if(c[0].text.startsWith('Считаем')){return;}g.cancel();c.forEach((j.Element h){j.Element d=h.querySelector('a');if(d==null){return;}d.text=d.text.replaceAllMapped(new RegExp('^(\\d+) комментариев\$'),(Match f){int b=int.parse(f[1]);if((b%100/10).round()!=1){int e=b%10;if(e==1){return '${b} комментарий';}else if(e>=2&&e<=4){return '${b} комментария';}}return f[0];});});});}void sB(){if(xB()){yB();}}bool xB(){final j.NodeValidatorBuilder zB=new j.NodeValidatorBuilder.common()..allowElement('span',attributes:['data-linenum']);j.ElementList i=j.querySelectorAll('pre > code.sourceCode');if(i.length>0){k.JsObject q=k.context['hljs'];i.forEach((j.HtmlElement e){q.callMethod('highlightBlock',[e]);List<String> c=e.innerHtml.split('\n');RegExp r=new RegExp(r'<span[\s\S]*?>');RegExp u=new RegExp(r'</span>');List<String> f=[] ;for(int b=0;b<c.length; ++b){String d='<span class="line" data-linenum="${b+1}">';if(c[b]==''){d+= '&nbsp;';}else{String g=f.join('')+c[b];d+= g;Iterable<Match> m=r.allMatches(g);Iterable<Match> v=u.allMatches(g);f=[] ;for(int h=v.length;h<m.length; ++h){f.add(m.elementAt(h).group(0));d+= '</span>';}}d+= '</span>';c[b]=d;}e.setInnerHtml(c.join('\n'),validator:zB);e.classes.add('highlighted');});return true;}else{return false;}}void yB(){j.Element f=new j.DivElement()..classes.add('tooltip-inner');j.Element b=new j.DivElement()..append(new j.DivElement()..classes.add('tooltip-arrow'))..append(f)..classes.addAll(['tooltip','left','fade']);b.classes.add(j.CssStyleDeclaration.supportsTransitions?'out':'in');b.style.display='none';j.document.body.append(b);b.onTransitionEnd.listen((j.TransitionEvent d){if(b.classes.contains('out')){b.style.display='none';}});void h(){if(!j.CssStyleDeclaration.supportsTransitions){b.style.display='none';}else{b.classes..remove('in')..add('out');}}void i(m){b.style..visibility='hidden'..display='block';b.style..left="${m.offsetLeft-b.clientWidth}px"..top="${m.offsetTop-2}px"..visibility="visible";if(j.CssStyleDeclaration.supportsTransitions){b.classes..remove('out')..add('in');}}j.Element c;bool e=false;var g=j.querySelectorAll('span.line');g.onClick.listen((j.MouseEvent d){if(c==d.currentTarget){if(!e){e=true;return;}h();c=null;e=false;return;}e=true;c=d.currentTarget;f.text='#'+c.getAttribute('data-linenum');i(c);});g.onMouseMove.listen((j.MouseEvent d){if(e||c==d.currentTarget){return;}c=d.currentTarget;f.text='#'+c.getAttribute('data-linenum');i(c);});g.onMouseOut.listen((j.MouseEvent d){if(e||c!=d.currentTarget){return;}h();c=null;});}void tB(){var e=j.querySelectorAll('.note-link');if(e.length==0){return;}j.Element f=new j.HeadingElement.h3()..classes.add('popover-title');j.DivElement g=new j.DivElement()..classes.add('popover-content');j.Element b=new j.DivElement()..append(new j.DivElement()..classes.add('arrow'))..append(f)..append(g)..classes.addAll(['popover','top','fade']);b.classes.add(j.CssStyleDeclaration.supportsTransitions?'out':'in');b.style.display='none';j.document.body.append(b);b.onTransitionEnd.listen((j.TransitionEvent h){if(b.classes.contains('out')){b.style.display='none';}});var d;final j.NodeValidatorBuilder zB=new j.NodeValidatorBuilder.common()..allowNavigation(new mB());e.onClick.listen((j.MouseEvent h){var c=h.currentTarget;if(d==c){if(!j.CssStyleDeclaration.supportsTransitions){b.style.display='none';}else{b.classes..remove('in')..add('out');}d=null;return;}f.text="Примечание ${c.text}";var i=j.querySelector('.footnotes li[data-for=${c.id}]');if(i==null){return;}g.setInnerHtml(i.innerHtml,validator:zB);d=c;b.style..visibility='hidden'..display='block';b.style..left="${c.offsetLeft+(c.clientWidth-b.clientWidth)/2+2}px"..top="${c.offsetTop-b.clientHeight}px"..visibility="visible";if(j.CssStyleDeclaration.supportsTransitions){b.classes..remove('out')..add('in');}});}void uB(){j.Element b=j.querySelector('.pager .previous');j.Element c=j.querySelector('.pager .next');bool f=j.window.navigator.platform.indexOf('Mac')!=-1;if(b!=null){b.attributes['title']+=" (${f?'⌥←':'Ctrl + ←'})";}if(c!=null){c.attributes['title']+=" (${f?'⌥→':'Ctrl + →'})";}if(b!=null||c!=null){j.document.onKeyDown.listen((j.KeyboardEvent d){if(d.altKey||d.ctrlKey){j.Element e;if(d.keyCode==j.KeyCode.LEFT){e=b;}else if(d.keyCode==j.KeyCode.RIGHT){e=c;}if(e!=null){j.window.location.replace(e.querySelector('a').getAttribute('href'));}}});}}void vB(){if(j.querySelectorAll('span.math').length>0){j.Element b=new j.ScriptElement()..type="text/javascript"..async=true..src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML";j.document.body.append(b);}}}class mB implements j.UriPolicy{bool allowsUri(String b){return true;}}class PB{static const String GB="/map";static const String CB="#ffffdd";static final Map<String,String> DB=<String,String>{'blue':'#a3cec5','green':'#d3e46f','orange':'#fdc663','pink':'#f3c1d3','purple':'#ceb5cf','red':'#fdaf6b','turquoise':'#aadb78','yellow':'#fae364'};num width;num height;k.JsObject svg;k.JsObject n;k.JsObject map;k.JsObject zoom;k.JsFunction FB;k.JsFunction path;j.Element t;j.Element o;var AB;var l;List z;void EB(){map=k.context['d3'].callMethod('select',['.map']);width=map.callMethod('property',['clientWidth']);height=width*0.57;zoom=k.context['d3']['behavior'].callMethod('zoom').callMethod('scaleExtent',[new k.JsObject.jsify([1,60])]).callMethod('size',[new k.JsObject.jsify([width,height])]).callMethod('on',["zoom",ZB]);t=new j.DivElement()..classes.addAll(['country-tooltip','hidden']);j.querySelector('.map').append(t);o=j.querySelector('.popover.info');o.onClick.listen((AC)=>BB());UB();j.HttpRequest.request('${GB}/world.json').then((j.HttpRequest b){var c=NB.JSON.decode(b.responseText);j.HttpRequest.request('${GB}/data.json').then((j.HttpRequest b){var d=NB.JSON.decode(b.responseText);LB(c,d);},onError:(AC){j.window.alert("Error loading visited countries data");LB(c,{});});},onError:(AC)=>j.window.alert("Error loading world data."));}void LB(b,d){l=d;AB=k.context['topojson'].callMethod('feature',[new k.JsObject.jsify(b),new k.JsObject.jsify(b['objects']['countries'])])['features'];var e=k.context['topojson'].callMethod('feature',[new k.JsObject.jsify(b),new k.JsObject.jsify(b['objects']['subunits'])])['features'];AB.addAll(e);var f=k.context['topojson'].callMethod('feature',[new k.JsObject.jsify(b),new k.JsObject.jsify(b['objects']['regions'])])['features'];AB.addAll(f);z=[] ;l.forEach((AC,c){if(c['cities']!=null){z.addAll(c['cities']);}});WB();VB();XB();}void UB(){FB=k.context['d3']['geo']['polyhedron'].callMethod('waterman').callMethod('scale',[0.121841155*width]).callMethod('translate',[new k.JsObject.jsify([width/2,height/2])]).callMethod('rotate',[new k.JsObject.jsify([20,0])]);k.JsObject b=k.context['d3']['geo'].callMethod('graticule').callMethod('minorStep',[new k.JsObject.jsify([5,5])]);path=k.context['d3']['geo'].callMethod('path').callMethod('projection',[FB]).callMethod('pointRadius',[1]);svg=map.callMethod('append',['svg']).callMethod('attr',['width',width]).callMethod('attr',['height',height]).callMethod('call',[zoom]);k.JsObject c=svg.callMethod('append',['defs']).callMethod('append',['clipPath']).callMethod('attr',['id','outlineClipPath']);c.callMethod('append',['path']).callMethod('datum',[new k.JsObject.jsify({"type":"Sphere"})]).callMethod('attr',['class','graticule outline']).callMethod('attr',['d',path]);n=svg.callMethod('append',['g']).callMethod('style',['clip-path','url(#outlineClipPath)']);n.callMethod('append',['path']).callMethod('datum',[new k.JsObject.jsify({"type":"Sphere"})]).callMethod('attr',['class','background']).callMethod('attr',['d',path]).callMethod("on",["click",(d,e,[AC])=>BB()]);n.callMethod('append',['path']).callMethod('datum',[b]).callMethod('attr',['class','graticule']).callMethod('attr',['d',path]);n.callMethod("style",["stroke-width",1]).callMethod('attr',["transform","translate(0,0)scale(1)"]);}void YB(){n.callMethod("append",['path']).callMethod("datum",[new k.JsObject.jsify({'type':"Sphere"})]).callMethod("attr",["class","graticule outline"]).callMethod("attr",["d",path]);}void WB(){k.JsObject e=n.callMethod("selectAll",[".country"]).callMethod("data",[AB]);e.callMethod("enter").callMethod("insert",["path"]).callMethod("attr",["class","country"]).callMethod("attr",["d",path]).callMethod("attr",["id",(c,f,[AC])=>c['id']]).callMethod("style",["fill",(c,f,[AC]){String d;String b=c['id'];if(b.length>3){d=b;b=b.substring(0,3);}var m=l[b];if(m==null){return CB;}var g=m['color'];if(g==null||DB[g]==null){return CB;}if(d!=null){if(l[b]['regions']!=null&&l[b]['regions'][d]!=null){return DB[g];}return CB;}return DB[g];}]);YB();num r=map.callMethod("property",['offsetLeft'])+5;num u=map.callMethod("property",['offsetTop'])-40;e.callMethod("on",["mousemove",(c,f,[AC]){var h=k.context['d3'].callMethod("mouse",[svg.callMethod("node")]);var d;var b=c['id'];if(b.length>3){d=b;b=b.substring(0,3);}String i=TB(b,d);t..classes.remove("hidden")..style.left="${h[0]+r}px"..style.top="${h[1]+u}px"..innerHtml=i;}]);e.callMethod("on",["mouseout",(c,f,[AC])=>t.classes.add('hidden')]);e.callMethod("on",["click",(c,f,[AC]){var d;var b=c['id'];if(b.length>3){d=b;b=b.substring(0,3);}if(l[b]==null||l[b]['name']==null){BB();return;}String i=l[b]['name'];var h=k.context['d3'].callMethod("mouse",[svg.callMethod("node")]);List q=l[b]['cities'];q.sort((v,aB)=>v['name'].compareTo(aB['name']));Iterable bB=q.map((cB)=>"<li>${JB(cB)}</li>");MB(i,'<ul class="list-unstyled">${bB.join('')}</ul>',h);}]);}String TB(b,d){String c="Неизведанная территория";if(l[b]!=null&&l[b]['name']!=null){c=l[b]['name'];if(d!=null){if(l[b]['regions']!=null&&l[b]['regions'][d]!=null){c=l[b]['regions'][d]+' &mdash; '+c;}}}return c;}void VB(){var c=n.callMethod("selectAll",[".city"]).callMethod("data",[new k.JsObject.jsify(z)]);c.callMethod("enter").callMethod("insert",["path"]).callMethod("attr",["class","city"]).callMethod("attr",["d",(b,e,[AC])=>path.apply([new k.JsObject.jsify({"type":"Point","coordinates":[b['lon'],b['lat']]})])]);num f=map.callMethod("property",['offsetLeft'])+5;num g=map.callMethod("property",['offsetTop'])-40;c.callMethod("on",["mousemove",(b,e,[AC]){var d=k.context['d3'].callMethod("mouse",[svg.callMethod("node")]);t..classes.remove("hidden")..style.left="${d[0]+f}px"..style.top="${d[1]+g}px"..innerHtml=b['name'];}]);c.callMethod("on",["mouseout",(b,e,[AC])=>t.classes.add('hidden')]);c.callMethod("on",["click",(b,e,[AC]){var d=k.context['d3'].callMethod("mouse",[svg.callMethod("node")]);MB(b['name'],"<p>${JB(b,true)}</p>",d);}]);}void XB(){num c=-1000000.0;num d=-1000000.0;num e=1000000.0;num f=1000000.0;z.forEach((h){var g=FB.apply([new k.JsObject.jsify([h['lon'],h['lat']])]);c=s.max(c,g[0]);e=s.min(e,g[0]);d=s.max(d,g[1]);f=s.min(f,g[1]);});num b=0.95/s.max((c-e)/width,(d-f)/height);List<num> i=[-(e+c)/2*b+width/2,-(f+d)/2*b+height/2];path=path.callMethod("pointRadius",[s.max(1/4,1/b)]);var u=n.callMethod("selectAll",['.city']);n.callMethod('transition').callMethod("duration",[5000]).callMethod("attr",["transform","translate(${i.join(',')})scale(${b})"]).callMethod("tween",["side-effects",(BC,CC,[AC]){var m=k.context['d3'].callMethod('interpolateNumber',[1,b]);return (v){var q=m.apply([v]);n.callMethod("style",["stroke-width",1/q]);path=path.callMethod("pointRadius",[s.max(1/4,1/q)]);u.callMethod("attr",["d",(r,m,[AC])=>path.apply([new k.JsObject.jsify({"type":"Point","coordinates":[r['lon'],r['lat']]})])]);};}]);zoom.callMethod("translate",[new k.JsObject.jsify(i)]);zoom.callMethod("scale",[b]);}void ZB([DC,EC,FC]){k.JsObject d=k.context['d3']['event']['translate'];List<num> b=<num>[d[0],d[1]];num c=k.context['d3']['event']['scale'];b[0]=s.max(s.min(b[0],0),width*(1-c));b[1]=s.max(s.min(b[1],0),height*(1-c));path=path.callMethod("pointRadius",[s.max(1/4,1/c)]);zoom.callMethod("translate",[new k.JsObject.jsify(b)]);n.callMethod("style",["stroke-width",1/c]).callMethod("attr",["transform","translate(${b.join(',')})scale(${c})"]);n.callMethod("selectAll",['.city']).callMethod("attr",["d",(e,f,[AC])=>path.apply([new k.JsObject.jsify({"type":"Point","coordinates":[e['lon'],e['lat']]})])]);BB();}void MB(String e,String f,c){num g=map.callMethod("property",['offsetLeft'])+5;num d=map.callMethod("property",['offsetTop'])-40;o.querySelector('.popover-title').innerHtml=e;o.querySelector('.popover-content').innerHtml=f;o.style.display='block';int h=o.clientWidth;int i=o.clientHeight;int b=c[1]+d-i+40;o.classes.toggle('top',b>=60);o.classes.toggle('bottom',b<60);if(b<60){b=c[1]+d+40;}o.style..left="${c[0]+g-h/2-3}px"..top="${b}px";}void BB(){o.style.display='none';}static final List<String> w=<String>['январь','февраль','март','апрель','май','июнь','июль','август','сентябрь','октябрь','ноябрь','декабрь'];String KB(b){var c='';int d=b['yearFrom'];if(d==null){d=b['year'];if(d==null){d=b['yearTo'];}}int g=b['yearTo'];if(g==null){g=b['year'];if(g==null){g=b['yearFrom'];}}int e=b['monthFrom'];if(e==null){e=b['month'];if(e==null){e=b['monthTo'];}}int f=b['monthTo'];if(f==null){f=b['month'];if(f==null){f=b['monthFrom'];}}if(d!=null){if(d!=g){if(e!=null){c+= w[e-1]+' ';}c+= "${d} &ndash; ";if(f!=null){c+= w[f-1]+' ';}c+= g.toString();}else if(e!=null){c+= w[e-1]+' ';if(e!=f){c+= '&ndash; ${w[f-1]} ';}c+= d.toString();}else{c+= d.toString();}}if(c!=''){c='<small>${c}</small>';}return c;}String JB(b,[bool e=false]){if(b['visits']!=null&&b['visits'][0]!=null){String c=KB(b['visits'][0]);String d=(e?'':b['name'])+(c!=''?' '+c:'');if(b['visits'][0]['link']!=null){d='<a href="${b['visits'][0]['link']}">${d}</a>';}for(int f=1;f<b['visits'].length; ++f){var g=b['visits'][f];c=KB(g);if(c!=''){if(g['link']!=null){c='<a href="${g['link']}">${c}</a>';}d+= ", "+c;}}if(d==''&&e){d='<small>дата неизвестна</small>';}return d;}return e?'<small>дата неизвестна</small>':b['name'];}}void main(){OB b=new OB();b.EB();PB c=new PB();c.EB();}String HB(b)=>Uri.decodeComponent(b.replaceAll(r"\+",' '));String QB(DateTime f){var g=['Mon','Tue','Wed','Thi','Fri','Sat','Sun'];var h=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];var GC=(int c,int i){var d=c.toString();var e=i-d.length;return (e>0)?'${new List.filled(e,'0').join('')}${c}':d;};var b=f.toUtc();var m=GC(b.hour,2);var q=GC(b.minute,2);var r=GC(b.second,2);return '${g[b.weekday-1]}, ${b.day} ${h[b.month-1]} ${b.year} '+'${m}:${q}:${r} ${b.timeZoneName}';}String RB(String e){var h=new Map();var d=j.document.cookie!=null?j.document.cookie.split('; '):[] ;for(var b=0,f=d.length;b<f;b++ ){var c=d[b].split('=');var g=HB(c[0]);if(e==g){return c[1]!=null?HB(c[1]):null;}}return null;}void IB(String b,String c,{expires,path,domain,secure}){if(expires is num){expires=new DateTime.fromMillisecondsSinceEpoch(new DateTime.now().millisecondsSinceEpoch+expires*24*60*60*1000);}var d=([Uri.encodeComponent(b),'=',Uri.encodeComponent(c),expires!=null?'; expires='+QB(expires):'',path!=null?'; path='+path:'',domain!=null?'; domain='+domain:'',secure!=null&&secure==true?'; secure':''].join(''));j.document.cookie=d;}